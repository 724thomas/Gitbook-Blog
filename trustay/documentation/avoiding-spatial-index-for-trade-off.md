---
description: '대량 위치 기반 조회에서 Spatial Index를 쓰지 않은 이유: 정확도 vs 성능 트레이드 오프'
---

# Avoiding spatial index for trade-off

## 문제

거리 기반 대상 추출(예: 반경 10km)은 알림 대상을 식별하기 위한 필터로 사용됩니다.\
처음에는 Spatial Index + MBR(사각형) 기반 조회로 빠르게 후보를 좁히고 마지막에 실제 거리 계산으로 정확도를 확보하려고 했습니다.&#x20;

하지만 쿼리 분석 과정에서 Spatial Index가 DB에 부담을 주는 것을 확인하였고, 팀 내부에서 논의 끝에

#### "정확도 100%" 보다 "안정적으로 끝나는 처리량"

으로 변경하기로 했습니다.



#### 기존 접근: MBR Contains + 최종 거리 계산

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

1. 반경 원을 포함하는 사각형의 4 꼭지점을 계산. O(4)
2. 해당 사각형이 포함되는 좌표를 spatial index로 조회. O(1)
3. 조회된 좌표들에 대해 실제 거리를 단건씩 계산하여 정확히 '반경 내' 필터링. O(n)

위 방식의 장점으로는 정확도가 높고, 공간 인덱스로 후보를 빠르게 좁힐 수 있습니다.



#### 하지만 실제 운영에서의 문제는:

* 대량 처리에서 3. "단건 거리 계산. O(n)"이 누적되면서 DB CPU 부하가 커지는 것을 AWS 모니터링을 통해 확인
* 운영 장애 상황에서는 "DB가 죽지 않고 끝까지 처리하는 것"이 우선목표.



#### 이에, 선택한 트레이드 오프는 "원" 대신 "사각형"으로 결정(정확도 일부 포기)

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

* &#x20;3\. 에서 실제 거리 단건 계산을 생략하고
* &#x20;2\. 에서 얻은 사각형(MBR) 범위 기준으로 "반경 근사" 필터링으로 처리하게 됐습니다.



#### 이 결정에 대한 영향도는,

* 정확도 감소: 원형 반경이 아니라 사각형 이준이므로, 경계 구간에서 "반경 밖"이 포함될 수 있습니다.
* 성능 향상: 단건 거리 계산 제거로 DB CPU 부하를 줄이고, 대량 배치 작업의 안정성 확보



#### 추가 고려사항(데이터 정합성)

경도/위도가 DB에 반대로 저장되어 있어 문제가 될 수 있었지만, 서버에서 제어 가능하도록 하여 운영 리스크를 낮췄습니다. 추후 데이터 마이그레이션을 진행하더라도 문제되지 않게 설계했습니다.



이번 케이스는 공간 인덱스를 맹목적으로 신뢰하지 않고, 실제 쿼리 비용과 장애 대응을 기준으로 정확도-성능 균형점을 다시 잡게된 사례입니다.
